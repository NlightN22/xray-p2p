# XRAY-p2p Trojan Tunnel

**Краткое:** Этот проект поднимает простую серверную и клиентскую часть на базе **xray-core** в среде OpenWrt и настраивает минимальный туннель по протоколу **trojan**. Включены шаблоны конфигураций и скрипты для облегчения установки.

---

## Что делает проект

* Автоматизирует установку и настройку XRAY (сервер + клиент) на OpenWrt.
* Генерирует/устанавливает TLS-сертификаты.
* Настраивает учетные записи trojan (пароли/емейлы) и сохраняет метаданные подключений на сервере, чтобы избежать повторного использования.
* Проверяет валидность конфигураций и перезапускает сервис.

---

## Зависимости

* `xray-core` (server & client)
* `jq` (обработка JSON в скриптах)
* `openssl` или `acme.sh`

## Быстрый старт — Сервер (основная последовательность)

1. Скопировать репозиторий на сервер OpenWrt.
2. Установить зависимости: `opkg update && opkg install xray jq openssl`.
3. Запустить `scripts/install_server.sh` и ввести интерактивно параметры:

   * Public IP сервера
   * serverName (для TLS)
   * trojan port
   * trojan email (или сгенерировать случайный)
   * trojan password
   * ssh connection `user@ip:port`
4. Скрипт:

   * Подставит переменные в шаблон `templates/xray-server.json.tpl`.
   * Создаст сертификаты (в `data/certs/`).
   * Проверит конфигурацию.
   * Запустит/перезапустит xray.
5. Проверить статус `logread` / `ps` / `ubus` (в зависимости от версии OpenWrt).

---

## Быстрый старт — Клиент (основная последовательность)

1. На сервере добавить запись о новом клиенте (скрипт может запрашивать список ещё не подключённых клиентов).
2. На клиенте запустить `scripts/install_client.sh` и указать строку соединения, полученную от сервера.
3. Скрипт:

   * Получит параметры от сервера (ip, port, password, serverName).
   * Подставит их в `templates/xray-client.json.tpl`.
   * Запишет метаданные на сервер (через ssh/scp или api) чтобы пометить клиента как "используется".
   * Запустит xray клиента и проверит подключение.

---

## Как сервер и клиент обмениваются данными

* Сервер хранит `data/clients.json` с метаданными: `[{"id":"uuid","password":"...","used":false,"created":"..."}]`.
* Клиент запрашивает (scp/ssh/API) у сервера следующую незанятую запись и помечает её как `used:true`.
* Для автоматизации можно использовать `ssh user@server 'cat /path/to/data/next_client.json'`.

---

## Проверки и отладка

* Проверить конфиг: `xray -test -c /etc/xray/config.json`.
* Логи: `/var/log/xray/*` или `logread | grep xray`.
* Проверка соединения с клиента: `curl --socks5 127.0.0.1:1080 https://ifconfig.me` (или `nc`/`telnet` для порта trojan).

---

## Безопасность и замечания

* Сервер должен иметь публичный IP и открытый SSH (как вы просили). Ограничьте SSH ключами и брандмауэром по IP по возможности.
* Храните пароли клиентов в защищённом месте (права 600 на `data/clients.json`).
* По возможности используйте реальные ACME сертификаты вместо self-signed.

---

## Дальше (идеи для улучшения)

* Добавить API на сервер (HTTP+authentication) для выдачи клиентов и пометки их как используемые.
* Интеграция `acme.sh` для автоматического получения и обновления сертификатов.
* Управление через UCI/Netifd для стартапа в OpenWrt стиле.

---


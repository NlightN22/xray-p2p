name: ci

on:
  push:
    branches: ["**"]
  pull_request:

jobs:
  linux:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version-file: go.mod
          check-latest: true
          cache: true

      - name: go test
        run: |
          set -euo pipefail
          go test ./...

  openwrt:
    needs: linux
    runs-on: ubuntu-latest
    env:
      OPENWRT_VERSION: "23.05.3"
      OPENWRT_TARGET: "x86"
      OPENWRT_SUBTARGET: "64"
      OPENWRT_SDK_TARBALL: "openwrt-sdk-23.05.3-x86-64_gcc-12.3.0_musl.Linux-x86_64.tar.xz"
      OPENWRT_SDK_URL: "https://downloads.openwrt.org/releases/23.05.3/targets/x86/64/openwrt-sdk-23.05.3-x86-64_gcc-12.3.0_musl.Linux-x86_64.tar.xz"
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y bc build-essential ca-certificates curl file gawk git jq \
            libelf-dev libncurses5-dev libncursesw5-dev libssl-dev opkg pkg-config python3 \
            python3-distutils rsync subversion tar time unzip wget xz-utils zip zlib1g-dev

      - name: Download OpenWrt SDK
        run: |
          set -euo pipefail
          mkdir -p "$RUNNER_TEMP/openwrt"
          cd "$RUNNER_TEMP/openwrt"
          curl -L "$OPENWRT_SDK_URL" -o sdk.tar.xz
          tar -xf sdk.tar.xz
          SDK_DIR=$(tar -tf sdk.tar.xz | head -n 1 | cut -d/ -f1)
          mv "$SDK_DIR" "$RUNNER_TEMP/openwrt-sdk"
          echo "SDK_DIR=$RUNNER_TEMP/openwrt-sdk" >> "$GITHUB_ENV"

      - name: Build xp2p ipk
        run: |
          set -euo pipefail
          OPENWRT_SDK_DIR="$SDK_DIR" \
          XP2P_FEED_PATH="$GITHUB_WORKSPACE/openwrt/feed" \
            "$GITHUB_WORKSPACE/tests/guest/scripts/build_openwrt_xp2p.sh"

      - name: Locate artifact
        id: locate-ipk
        run: |
          set -euo pipefail
          cd "$SDK_DIR"
          pkg=$(find bin/packages -type f -name "xp2p_*.ipk" | head -n 1 || true)
          if [ -z "$pkg" ]; then
            echo "No xp2p ipk produced" >&2
            exit 1
          fi
          pkg_path=$(realpath "$pkg")
          echo "ipk=$pkg_path" >> "$GITHUB_OUTPUT"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: xp2p-ipk
          path: ${{ steps.locate-ipk.outputs.ipk }}

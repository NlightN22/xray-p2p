# frozen_string_literal: true

BOX_PATH = File.expand_path('../boxes/openwrt-24.10.2.box', __dir__)
PROJECT_ROOT = File.expand_path('../../..', __dir__)
HOST_IP = ENV.fetch('OPENWRT_HOST_IP', '10.0.10.30')
HOST_NETMASK = ENV.fetch('OPENWRT_HOST_NETMASK', '255.255.255.0')
HOST_INTERFACE = ENV.fetch('OPENWRT_HOST_INTERFACE', 'eth1')

Vagrant.configure('2') do |config|
  config.vm.box = 'openwrt-24.10.2'
  config.vm.box_url = BOX_PATH
  config.vm.hostname = 'openwrt-server'

  config.ssh.insert_key = false
  config.vm.boot_timeout = 200
  config.vm.synced_folder '.', '/vagrant', disabled: true

  config.vm.network 'forwarded_port', guest: 22, host: 2222, auto_correct: true
  config.vm.network 'private_network', ip: HOST_IP, auto_config: false

  # Sync the entire repo via SMB (no Guest Additions required)
  config.vm.synced_folder PROJECT_ROOT, '/srv/project', type: 'smb',
                          mount_options: ['vers=3.0', 'mfsymlinks']

  config.vm.provider 'virtualbox' do |vb|
    vb.name = 'openwrt-24.10.2-server'
    vb.gui = false
  end

  config.vm.provision 'shell', privileged: true, inline: <<~SH
    set -e
    if ! opkg list-installed | grep -q '^kmod-fs-cifs '; then
      opkg update || true
      opkg install kmod-fs-cifs cifs-utils
    fi

    uci -q delete network.host
    uci set network.host='interface'
    uci set network.host.device='#{HOST_INTERFACE}'
    uci set network.host.proto='static'
    uci set network.host.ipaddr='#{HOST_IP}'
    uci set network.host.netmask='#{HOST_NETMASK}'
    if uci -q show firewall.lan >/dev/null 2>&1; then
      uci -q del_list firewall.lan.network='host'
      uci add_list firewall.lan.network='host'
    fi
    uci commit network
    uci commit firewall 2>/dev/null || true
    /etc/init.d/network reload
  SH
end

project_root = File.expand_path('../../..', __dir__)

BOX_PATH = File.expand_path('../boxes/openwrt-24.10.2.box', __dir__)
BOX_NAME = 'openwrt-24.10.2'.freeze
BUILD_OUTPUT = File.join(project_root, 'build', 'ipk')
HOST_NETMASK = ENV.fetch('OPENWRT_HOST_NETMASK', '255.255.255.0')
HOST_INTERFACE = ENV.fetch('OPENWRT_HOST_INTERFACE', 'eth1')

MACHINES = [
  { id: 'openwrt-a', hostname: 'openwrt-a', vb_name: 'openwrt-a', forwarded_port: 2221, private_ip: '10.62.20.11' },
  { id: 'openwrt-b', hostname: 'openwrt-b', vb_name: 'openwrt-b', forwarded_port: 2222, private_ip: '10.62.20.12' },
  { id: 'openwrt-c', hostname: 'openwrt-c', vb_name: 'openwrt-c', forwarded_port: 2223, private_ip: '10.62.20.13' },
].freeze

Vagrant.configure('2') do |config|
  MACHINES.each do |machine|
    config.vm.define machine[:id] do |vm|
      vm.vm.box = BOX_NAME
      vm.vm.box_url = BOX_PATH
      vm.vm.hostname = machine[:hostname]

      vm.ssh.insert_key = false
      vm.vm.boot_timeout = 200
      vm.vm.synced_folder '.', '/vagrant', disabled: true

      vm.vm.network 'forwarded_port', guest: 22, host: machine[:forwarded_port], auto_correct: true
      vm.vm.network 'private_network', ip: machine[:private_ip], auto_config: false

      vm.vm.provider 'virtualbox' do |vb|
        vb.name = machine[:vb_name]
        vb.gui = false
      end

      vm.vm.provision 'file', source: BUILD_OUTPUT, destination: '/tmp/build-openwrt'
      vm.vm.provision 'shell', path: 'provision-packages.sh'
    end
  end
end
